# EllapsoidToElevation-v2
CSV内の楕円体高の列を標高に差し替えて出力します(2025年4月 ジオイドデータ＋基準面補正量対応)
【注意】
######## このバージョン 2025/4/1以降は国土地理院からの新ジオイドデータに対応しています。。########

CSV内の楕円体高の列を標高に差し替えて出力します。
緯度、経度、楕円体高を含むCSVファイルを読込んで、楕円体高を標高に差し替えて別名で出力するPythonプログラムです。

国土地理院のデータを利用するため、対応範囲は日本国内のみです。


利用方法

　①準備　国土地理院データのダウンロード
　国土地理院の基板地図情報ダウンロードサービスに登録・ログインし、
	『「ジオイド2024日本とその周辺」と「基準面補正パラメータ」の提供』サイト（https://service.gsi.go.jp/kiban/app/geoid/）から
　　JPGEO2024_isg.zip をダウンロードしてください。

	解凍した下記2つのファイルを py ファイルのあるフォルダに置きます
	1	JPGEO2024.isg	「ジオイド2024日本とその周辺」
	2	Hrefconv2024.isg	「基準面補正パラメータ」

　②実行方法
　コマンドラインにて下記のように入力ファイルと出力ファイルを指定します。

　python EllapsoidToElevation.py [入力ファイル] [出力ファイル]


標高の計算は次の式を用います。

	標高 = 楕円体高 - （ジオイド高 + 基準面補正量）

ジオイド高のデータは、国土地理院が https://service.gsi.go.jp/kiban/app/geoid/ にて配布しているジオイドモデルJPGEO2024 のデータを利用します。
利用にあたっては、あらかじめ国土地理院のサイト https://service.gsi.go.jp/kiban/app/geoid/ から、ジオイドデータを各自ダウンロードしてご利用ください（要ログイン）。
また、「基準面補正パラメータ」も利用します。

ジオイド計算の部分は上記ジオイドデータとともに配布されている「manual2024.pdf」に掲載されている「ジオイド高内挿計算」の数式を利用し、Pythomで記述しています。

最初に実行したときは国土地理院のジオイドデータファイルを読み込んでデータモジュールを作ります。次回以降はデータファイルを用いず、データモジュールから読込を行います。これにより若干処理速度が向上します。
なお、このリポジトリには参考として、予め「JPGEO2024.isg」「Hrefconv2024.isg」より作成したデータモジュール「geoidData２.py」を置いています。

処理対象のCSVはAgisoftMetashapeのエクスポートファイルを想定しています。
・1行目か2行目がヘッダ。"latitude","longitude","altitude" の3つの文言があればヘッダと認識します。
・"lat","long"(または"lon"または"lng"),"alt" の3つの文言でも構いません。
・へッダから区切り文字列を推測するようになっています。
・ヘッダ文字列から緯度、経度、高度のカラムを特定するようになっています

本プログラムは日本国内でのみ利用できるので、メッセージ等は日本語にしています。

【注意】
国土地理院のデータから近傍のジオイド値が取れない場合は、無効値として-9999.0000が返ります。
その場合、該当するデータの標高値を-9999.0000に置換し、エラーメッセージを表示します。
